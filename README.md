# qbconf
Retrieves EKS config as single binary - perfect for CICD


https://github.com/kubernetes-sigs/aws-iam-authenticator#4-set-up-kubectl-to-use-heptio-authenticator-for-aws-tokens
https://stupefied-goodall-e282f7.netlify.app/contributors/design-proposals/auth/kubectl-exec-plugins/

# tinker about : 
* Important is the way that token is generated for EKS - check for 
  > x-k8s-aws-id - as header 
  > k8s-aws-v1. - as prefix for generated token
  Bit more insights into generating tokens
  > https://github.com/aws/aws-sdk-go/issues/2167
  > https://medium.com/@rschoening/eks-client-authentication-f17f39228dc
* modify credentials in our CLI to respect assumeRole - otherwise we are not authorized!
* Must use "sigs.k8s.io/yaml" for YAML - otherwise we get errors
* https://kubernetes.io/docs/reference/access-authn-authz/authentication/#client-go-credential-plugins
* https://github.com/kubernetes-sigs/aws-iam-authenticator
* investigate if we need to build initial config for AWS with credentials that will assume role ( GetCallerIdentityResponse ) as we should be getting assume role within our response ( hence the unathorized ) https://docs.aws.amazon.com/STS/latest/APIReference/API_GetCallerIdentity.html

‚ùØ aws --profile nlo-admin-cli --region eu-central-1 eks get-token --role-arn 'arn:aws:iam::107641125883:role/OrganizationAccountAccessRole' --cluster-name nlo-dev-gateway | jq

https://github.com/aws/aws-sdk-go-v2/pull/1030
https://github.com/skmcgrail/aws-sdk-go-v2/blob/main/aws/signer/v4/v4_test.go

```
    exec:
      apiVersion: client.authentication.k8s.io/v1alpha1
      args: []
      command: /Users/rafpe/personal/eks-k8s-config/main
      env: null
      provideClusterInfo: false
```


```
https://sts.eu-central-1.amazonaws.com/?Action=GetCallerIdentity
&Version=2011-06-15&
X-Amz-Algorithm=AWS4-HMAC-SHA256&
X-Amz-Credential=AKIAQPLA32E4TRRHIEX7/20210216/eu-central-1/sts/aws4_request&
X-Amz-Date=20210216T133233Z&
X-Amz-Expires=840&
X-Amz-SignedHeaders=host;x-k8s-aws-id&
X-Amz-Signature=c2aa8a09e4839f3da7a94266a64e6bc391febd5eb29e5bf4d87928f7b56c6b07

# Generated by aws eks get-token operation
https://sts.eu-central-1.amazonaws.com/?Action=GetCallerIdentity
&Version=2011-06-15&
X-Amz-Algorithm=AWS4-HMAC-SHA256&
X-Amz-Credential=ASIARSD7JHP5RHI33VVL/20210216/eu-central-1/sts/aws4_request&
X-Amz-Date=20210216T005132Z&
X-Amz-Expires=60&
X-Amz-SignedHeaders=host;x-k8s-aws-id&
X-Amz-Security-Token=IQoJb3JpZ2luX2VjEDEaDGV1LWNlbnRyYWwtMSJIMEYCIQDYKs9GhZMDbP/I7luxIMCioOHKUkQiP6+VATZH/O0d3AIhAPxGTMEJYRDjognJSNchGT3XSB30oNbx0ktWSvt39RQZKpwCCDoQAhoMMTA3NjQxMTI1ODgzIgzntzYo7vA+h++WNTMq+QH/nCMBoj67PRN91HPDi3Sz25JpsmZzsENqP0f0WT9rcOZYfZGm775DwAv1R/CgEGLVQimCmZIDtLYYaMC5oVsRZjxLs9fL1k+biX5ANl/aZIFFmf5aulFxHhwVZD1D2d2iWkVqP7v+Pp9uRe8CSoKzeIGtes8xEjzrIlJwFupimHaUEBJMvtD6ulbQuQdc5+amtlB5SU4Qv0ssMMftX+vtjoCgPmmSxcUnDezgvdECT+dhryEIAPxBGljQ4obw/C+5q4rRCQzi/kLGG4xJnOuOGwbPZgyaih8FN6pNTSUcJbTRwuUe1vJQxogPUaM4JFvRGDRG87c/xj4wlK6sgQY6nAEf7RVjf/Q2FzUV34Q2sUDBxxOPrJRFevpllI8fxCa5gQAuZcbTP5J3Poehl7pBq4kt9HjDi/GCKnt31GXYewxrRyO4mKtvf7Bb3gU38jb64X8CW2GV69lb1W9E/HigWyqqyJjGgfCXXY/f8AC+qqyEY/MhLiHOluAu4CpyS2wTM5LsG/zJuhME6exFybLmMs0hPLl7XOFPKNe8baY=&
X-Amz-Signature=43124c732fa301ce2821d5026067d38b101310e3d03030d6dba3523a8c5627ca

# Generated by native CLI methods
https://sts.eu-central-1.amazonaws.com/?Action=GetCallerIdentity
&Version=2011-06-15&
X-Amz-Algorithm=AWS4-HMAC-SHA256&
X-Amz-Credential=AKIAQPLA32E4TRRHIEX7/20210216/eu-central-1/sts/aws4_request&
X-Amz-Date=20210216T005611Z&
X-Amz-SignedHeaders=host&
X-Amz-User-Agent=aws-sdk-go-v2/1.2.0 os/other lang/go/1.15.2 md/GOOS/darwin md/GOARCH/amd64&
X-Amz-Signature=cd8b33313134577720d6982d7ae3aced69952f5b42d900925a7e8a0a8ef75ac2

# Generated by me
https://sts.eu-central-1.amazonaws.com?Action=GetCallerIdentity
&Version=2011-06-15&
X-Amz-Algorithm=AWS4-HMAC-SHA256&
X-Amz-Credential=AKIAQPLA32E4TRRHIEX7/19700101/eu-central-1/sts/aws4_request&
X-Amz-Date=19700101T000000Z&
X-Amz-Expires=60&
X-Amz-SignedHeaders=host;x-k8s-aws-id&
X-Amz-Signature=93b7bdf11611bb310949a74d66e6fd7db1e2027e7cda4c8ab1fb15cf2d0cab57




```